switch:
  # Power Metering Plug Dishwaser
  - platform: mystrom
    host: 10.10.70.13
    name: Plug Dishwasher

sensor:
  # Extract power attribute from dishwasher plug
  - platform: template
    sensors:
      power_dishwasher:
        friendly_name: Strom Geschirrsp√ºler
        unit_of_measurement: "W"
        device_class: power
        value_template: "{{ state_attr('switch.plug_dishwasher', 'current_power_w') }}"
  # Convert power (W) to energy (kWh)
  - platform: integration
    source: sensor.power_dishwasher
    name: energy_dishwasher
    unit_prefix: k
    round: 2

input_select:
  # Dishwasher state
  status_dishwasher:
    name: Status Geschirrsp√ºler
    options:
      - Sauber
      - Dreckig
      - L√§uft

# Utility Meter Dishwasher
utility_meter:
  energy_daily_dishwasher:
    source: sensor.energy_dishwasher
    cycle: daily
    tariffs:
      - Hochtarif
      - Niedertarif
  energy_quarterly_dishwasher:
    source: sensor.energy_dishwasher
    cycle: quarterly

automation:
  # Determine Dishwasher State
  - id: determine_dishwasher_state
    alias: Status Geschirrsp√ºler
    mode: single
    trigger:
      # -> Running
      - platform: numeric_state
        entity_id: sensor.power_dishwasher
        above: 30
        for:
          minutes: 2
      # -> Clean
      - platform: numeric_state
        entity_id: sensor.power_dishwasher
        below: 5
        for:
          minutes: 35
      # -> Dirty
      - platform: state
        entity_id: input_select.status_dishwasher
        to: 'Sauber'
        for:
          hours: 4
    action:
      - variables:
          new_state: "{{ trigger.to_state.state }}"
      - choose:
          # -> Running
          - conditions:
              - "{{ new_state | float > 30 }}"
              - "{{ not is_state('input_select.status_dishwasher', 'L√§uft') }}"
            sequence:
              - service: input_select.select_option
                data:
                  entity_id: input_select.status_dishwasher
                  option: 'L√§uft'
          # -> Clean
          - conditions:
              - "{{ new_state | float < 5 }}"
              - "{{ is_state('input_select.status_dishwasher', 'L√§uft') }}"
            sequence:
              - service: input_select.select_option
                data:
                  entity_id: input_select.status_dishwasher
                  option: 'Sauber'
              - service: notify.mobile_app_phone_dimitri
                data:
                  title: "üçΩÔ∏è Geschirrsp√ºler fertig!"
                  message: >
                    Der Geschirrsp√ºler ist fertig. Zeit zum ausr√§umen.
          # -> Dirty
          - conditions:
              - "{{ new_state == 'Sauber' }}"
            sequence:
              - service: input_select.select_option
                data:
                  entity_id: input_select.status_dishwasher
                  option: 'Dreckig'

# Entity Customization
homeassistant:
  customize:
    # Door/Window Sensor
    binary_sensor.window_kitchen:
      friendly_name: Fenster K√ºche
      device_class: window
    binary_sensor.door_kitchen:
      friendly_name: T√ºr K√ºche
      device_class: door
    # Waterleak Sensors
    binary_sensor.water_leak_kitchen:
      friendly_name: Wasserleck K√ºche
      device_class: moisture
    # Battery Sensors
    sensor.battery_level_door_kitchen:
      friendly_name: T√ºr Sensor K√ºche
    sensor.battery_level_window_kitchen:
      friendly_name: Fenster Sensor K√ºche
    sensor.battery_level_water_leak_kitchen:
      friendly_name: Wasserleck Sensor K√ºche
    # Smart Plugs
    switch.plug_dishwasher:
      friendly_name: Plug Geschirrsp√ºler
      icon: mdi:dishwasher
    sensor.energy_dishwasher:
      friendly_name: Konsum Geschirrsp√ºler
      device_class: energy
    
